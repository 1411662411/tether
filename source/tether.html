<!DOCTYPE html>

<html>
<head>
  <title>tether.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="Gruntfile.html">
                Gruntfile.coffee
              </a>
            
              
              <a class="source" href="abutment.html">
                abutment.coffee
              </a>
            
              
              <a class="source" href="constraint.html">
                constraint.coffee
              </a>
            
              
              <a class="source" href="markAttachment.html">
                markAttachment.coffee
              </a>
            
              
              <a class="source" href="shift.html">
                shift.coffee
              </a>
            
              
              <a class="source" href="tether.html">
                tether.coffee
              </a>
            
              
              <a class="source" href="tooltip.html">
                tooltip.coffee
              </a>
            
              
              <a class="source" href="utils.html">
                utils.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>tether.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>{getScrollParent, getSize, getOuterSize, getBounds, getOffsetParent, extend, addClass, removeClass} = Tether.Utils

<span class="function"><span class="title">debounce</span></span> = (fn, time=<span class="number">16</span>) -&gt;
  pending = <span class="literal">false</span>

  <span class="keyword">return</span> -&gt;
    <span class="keyword">return</span> <span class="keyword">if</span> pending

    args = arguments

    pending = <span class="literal">true</span>
    setTimeout =&gt;
      pending = <span class="literal">false</span>
      fn.apply @, args
    , time

tethers = []

<span class="function"><span class="title">position</span></span> = -&gt;
  <span class="keyword">for</span> tether <span class="keyword">in</span> tethers
    tether.position()

lastCall = <span class="literal">null</span>
<span class="keyword">for</span> event <span class="keyword">in</span> [<span class="string">'resize'</span>, <span class="string">'scroll'</span>]
  window.addEventListener event, -&gt;
    <span class="keyword">if</span> <span class="keyword">not</span> lastCall? <span class="keyword">or</span> (<span class="keyword">new</span> Date - lastCall) &gt; <span class="number">16</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>IE likes to call events a little too frequently</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      lastCall = +<span class="keyword">new</span> Date
      
      position()

MIRROR_LR =
  center: <span class="string">'center'</span>
  left: <span class="string">'right'</span>
  right: <span class="string">'left'</span>

MIRROR_TB =
  middle: <span class="string">'middle'</span>
  top: <span class="string">'bottom'</span>
  bottom: <span class="string">'top'</span>

OFFSET_MAP =
  top: <span class="string">'0'</span>
  left: <span class="string">'0'</span>
  middle: <span class="string">'50%'</span>
  center: <span class="string">'50%'</span>
  bottom: <span class="string">'100%'</span>
  right: <span class="string">'100%'</span>

<span class="function"><span class="title">autoToFixedAttachment</span></span> = (attachment, relativeToAttachment) -&gt;
  {left, top} = attachment

  <span class="keyword">if</span> left <span class="keyword">is</span> <span class="string">'auto'</span>
    left = MIRROR_LR[relativeToAttachment.left]

  <span class="keyword">if</span> top <span class="keyword">is</span> <span class="string">'auto'</span>
    top = MIRROR_TB[relativeToAttachment.top]

  {left, top}

<span class="function"><span class="title">attachmentToOffset</span></span> = (attachment) -&gt;
  <span class="keyword">return</span> {
    left: OFFSET_MAP[attachment.left] ? attachment.left
    top: OFFSET_MAP[attachment.top] ? attachment.top
  }

<span class="function"><span class="title">addOffset</span></span> = (offsets...) -&gt;
  out = {top: <span class="number">0</span>, left: <span class="number">0</span>}

  <span class="keyword">for</span> {top, left} <span class="keyword">in</span> offsets
    <span class="keyword">if</span> <span class="keyword">typeof</span> top <span class="keyword">is</span> <span class="string">'string'</span>
      top = parseFloat(top, <span class="number">10</span>)
    <span class="keyword">if</span> <span class="keyword">typeof</span> left <span class="keyword">is</span> <span class="string">'string'</span>
      left = parseFloat(left, <span class="number">10</span>)

    out.top += top
    out.left += left

  out

<span class="function"><span class="title">offsetToPx</span></span> = (offset, size) -&gt;
  <span class="keyword">if</span> <span class="keyword">typeof</span> offset.left <span class="keyword">is</span> <span class="string">'string'</span> <span class="keyword">and</span> offset.left.indexOf(<span class="string">'%'</span>) <span class="keyword">isnt</span> -<span class="number">1</span>
    offset.left = parseFloat(offset.left, <span class="number">10</span>) / <span class="number">100</span> * size.width
  <span class="keyword">if</span> <span class="keyword">typeof</span> offset.top <span class="keyword">is</span> <span class="string">'string'</span> <span class="keyword">and</span> offset.top.indexOf(<span class="string">'%'</span>) <span class="keyword">isnt</span> -<span class="number">1</span>
    offset.top = parseFloat(offset.top, <span class="number">10</span>) / <span class="number">100</span> * size.height

  offset

parseAttachment = <span class="function"><span class="title">parseOffset</span></span> = (value) -&gt;
  [top, left] = value.split(<span class="string">' '</span>)

  {top, left}

<span class="class"><span class="keyword">class</span> <span class="title">_Tether</span></span>
  <span class="property">@modules</span>: []

  constructor: (options) -&gt;
    tethers.push @

    <span class="property">@history</span> = []

    <span class="property">@setOptions</span> options, <span class="literal">false</span>

    <span class="keyword">for</span> module <span class="keyword">in</span> Tether.modules
      module.initialize?.call(@)

    <span class="property">@position</span>()

  getClass: (key) -&gt;
    <span class="keyword">if</span> <span class="property">@options</span>.classes?[key]
      <span class="property">@options</span>.classes[key]
    <span class="keyword">else</span> <span class="keyword">if</span> <span class="property">@options</span>.classes?[key] <span class="keyword">isnt</span> <span class="literal">false</span>
      <span class="keyword">if</span> <span class="property">@options</span>.classPrefix
        <span class="string">"<span class="subst">#{ @options.classPrefix }</span>-<span class="subst">#{ key }</span>"</span>
      <span class="keyword">else</span>
        key
    <span class="keyword">else</span>
      <span class="string">''</span>

  setOptions: (<span class="property">@options</span>, position=<span class="literal">true</span>) -&gt;
    defaults =
      offset: <span class="string">'0 0'</span>
      targetOffset: <span class="string">'0 0'</span>
      targetAttachment: <span class="string">'auto auto'</span>
      classPrefix: <span class="string">'tether'</span>

    <span class="property">@options</span> = extend defaults, <span class="property">@options</span>
      
    {<span class="property">@element</span>, <span class="property">@target</span>, <span class="property">@targetModifier</span>} = <span class="property">@options</span>

    <span class="keyword">if</span> <span class="property">@target</span> <span class="keyword">is</span> <span class="string">'viewport'</span>
      <span class="property">@target</span> = document.body
      <span class="property">@targetModifier</span> = <span class="string">'visible'</span>
    <span class="keyword">else</span> <span class="keyword">if</span> <span class="property">@target</span> <span class="keyword">is</span> <span class="string">'scroll-handle'</span>
      <span class="property">@target</span> = document.body
      <span class="property">@targetModifier</span> = <span class="string">'scroll-handle'</span>

    <span class="keyword">for</span> key <span class="keyword">in</span> [<span class="string">'element'</span>, <span class="string">'target'</span>]
      <span class="keyword">if</span> @[key].jquery?
        @[key] = @[key][<span class="number">0</span>]
      <span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">typeof</span> @[key] <span class="keyword">is</span> <span class="string">'string'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>This breaks viewport and scroll-handle attachment for the moment</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        @[key] = document.querySelector @[key]

      <span class="keyword">if</span> <span class="keyword">not</span> @[key]?
        <span class="keyword">throw</span> <span class="keyword">new</span> Error <span class="string">"Tether Error: Both element and target must be defined"</span>

    addClass <span class="property">@element</span>, <span class="property">@getClass</span> <span class="string">'element'</span>
    addClass <span class="property">@target</span>, <span class="property">@getClass</span> <span class="string">'target'</span>

    <span class="property">@targetAttachment</span> = parseAttachment <span class="property">@options</span>.targetAttachment
    <span class="property">@attachment</span> = parseAttachment <span class="property">@options</span>.attachment
    <span class="property">@offset</span> = parseOffset <span class="property">@options</span>.offset
    <span class="property">@targetOffset</span> = parseOffset <span class="property">@options</span>.targetOffset

    <span class="keyword">if</span> <span class="property">@scrollParent</span>?
      <span class="property">@disable</span>()

    <span class="property">@scrollParent</span> = getScrollParent <span class="property">@target</span>

    <span class="keyword">unless</span> <span class="property">@options</span>.enabled <span class="keyword">is</span> <span class="literal">false</span>
      <span class="property">@enable</span>(position)

  getTargetBounds: -&gt;
    <span class="keyword">if</span> <span class="property">@targetModifier</span>?
      <span class="keyword">switch</span> <span class="property">@targetModifier</span>
        <span class="keyword">when</span> <span class="string">'visible'</span>
          {top: pageYOffset, left: pageXOffset, height: innerHeight, width: innerWidth}
        <span class="keyword">when</span> <span class="string">'scroll-handle'</span>
          {
            top: pageYOffset + innerHeight * (pageYOffset / document.body.scrollHeight)
            left: innerWidth - <span class="number">15</span>
            height: innerHeight * <span class="number">0.98</span> * (innerHeight / document.body.scrollHeight)
            width: <span class="number">15</span>
          }
    <span class="keyword">else</span>
      getBounds <span class="property">@target</span>

  clearCache: -&gt;
    <span class="property">@_cache</span> = {}

  cache: (k, getter) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>More than one module will often need the same DOM info, so
we keep a cache which is cleared on each position call</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="property">@_cache</span> ?= {}

    <span class="keyword">if</span> <span class="keyword">not</span> <span class="property">@_cache</span>[k]?
      <span class="property">@_cache</span>[k] = getter.call(@)

    <span class="property">@_cache</span>[k]

  enable: (position=<span class="literal">true</span>) -&gt;
    <span class="property">@addClass</span> <span class="property">@getClass</span> <span class="string">'enabled'</span>
    <span class="property">@enabled</span> = <span class="literal">true</span>

    <span class="property">@scrollParent</span>.addEventListener <span class="string">'scroll'</span>, <span class="property">@position</span>

    <span class="keyword">if</span> position
      setTimeout =&gt; <span class="property">@position</span>()

  disable: -&gt;
    <span class="property">@removeClass</span> <span class="property">@getClass</span> <span class="string">'enabled'</span>
    <span class="property">@enabled</span> = <span class="literal">false</span>

    <span class="keyword">if</span> <span class="property">@scrollParent</span>?
      <span class="property">@scrollParent</span>.removeEventListener <span class="string">'scroll'</span>, <span class="property">@position</span>

  destroy: -&gt;
    <span class="property">@disable</span>()

    <span class="keyword">for</span> tether, i <span class="keyword">in</span> tethers
      <span class="keyword">if</span> tether <span class="keyword">is</span> @
        tethers.splice i, <span class="number">1</span>
        <span class="keyword">break</span>

  updateAttachClasses: (elementAttach=<span class="property">@attachment</span>, targetAttach=<span class="property">@targetAttachment</span>) -&gt;
    sides = [<span class="string">'left'</span>, <span class="string">'top'</span>, <span class="string">'bottom'</span>, <span class="string">'right'</span>, <span class="string">'middle'</span>, <span class="string">'center'</span>]
  
    <span class="property">@removeClass</span> <span class="string">"<span class="subst">#{ @getClass('element-attached') }</span>-<span class="subst">#{ side }</span>"</span> <span class="keyword">for</span> side <span class="keyword">in</span> sides
    <span class="property">@addClass</span> <span class="string">"<span class="subst">#{ @getClass('element-attached') }</span>-<span class="subst">#{ elementAttach.top }</span>"</span> <span class="keyword">if</span> elementAttach.top
    <span class="property">@addClass</span> <span class="string">"<span class="subst">#{ @getClass('element-attached') }</span>-<span class="subst">#{ elementAttach.left }</span>"</span> <span class="keyword">if</span> elementAttach.left

    <span class="property">@removeClass</span> <span class="string">"<span class="subst">#{ @getClass('target-attached') }</span>-<span class="subst">#{ side }</span>"</span> <span class="keyword">for</span> side <span class="keyword">in</span> sides
    <span class="property">@addClass</span> <span class="string">"<span class="subst">#{ @getClass('target-attached') }</span>-<span class="subst">#{ targetAttach.top }</span>"</span> <span class="keyword">if</span> targetAttach.top
    <span class="property">@addClass</span> <span class="string">"<span class="subst">#{ @getClass('target-attached') }</span>-<span class="subst">#{ targetAttach.left }</span>"</span> <span class="keyword">if</span> targetAttach.left

  addClass: (classes) -&gt;
    addClass <span class="property">@element</span>, classes
    addClass <span class="property">@target</span>, classes

  removeClass: (classes) -&gt;
    removeClass <span class="property">@element</span>, classes
    removeClass <span class="property">@target</span>, classes

  position: =&gt;
    <span class="keyword">return</span> <span class="keyword">unless</span> <span class="property">@enabled</span>

    <span class="property">@clearCache</span>()</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Turn &#39;auto&#39; attachments into the appropriate corner or edge</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    targetAttachment = autoToFixedAttachment(<span class="property">@targetAttachment</span>, <span class="property">@attachment</span>)

    <span class="property">@updateAttachClasses</span> <span class="property">@attachment</span>, targetAttachment

    elementPos = <span class="property">@cache</span> <span class="string">'element-bounds'</span>, =&gt; getBounds <span class="property">@element</span>
    {width, height} = elementPos

    targetSize = targetPos = <span class="property">@cache</span> <span class="string">'target-bounds'</span>, =&gt; <span class="property">@getTargetBounds</span>()</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Get an actual px offset from the attachment</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    offset = offsetToPx attachmentToOffset(<span class="property">@attachment</span>), {width, height}
    targetOffset = offsetToPx attachmentToOffset(targetAttachment), targetSize

    manualOffset = offsetToPx(<span class="property">@offset</span>, {width, height})
    manualTargetOffset = offsetToPx(<span class="property">@targetOffset</span>, targetSize)</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Add the manually provided offset</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    offset = addOffset offset, manualOffset
    targetOffset = addOffset targetOffset, manualTargetOffset</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>It&#39;s now our goal to make (element position + offset) == (target position + target offset)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    left = targetPos.left + targetOffset.left - offset.left
    top = targetPos.top + targetOffset.top - offset.top

    <span class="keyword">for</span> module <span class="keyword">in</span> Tether.modules
      ret = module.position.call(@, {left, top, targetAttachment, targetPos, elementPos, offset, targetOffset, manualOffset, manualTargetOffset})

      <span class="keyword">if</span> <span class="keyword">not</span> ret? <span class="keyword">or</span> <span class="keyword">typeof</span> ret <span class="keyword">isnt</span> <span class="string">'object'</span>
        <span class="keyword">continue</span>
      <span class="keyword">else</span> <span class="keyword">if</span> ret <span class="keyword">is</span> <span class="literal">false</span>
        <span class="keyword">return</span> <span class="literal">false</span>
      <span class="keyword">else</span>
        {top, left} = ret</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>We describe the position three different ways to give the optimizer
a chance to decide the best possible way to position the element
with the fewest repaints.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    next = {</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>It&#39;s position relative to the page (absolute positioning when
the element is a child of the body)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      page:
        top: top
        bottom: document.body.scrollHeight - top - height
        left: left
        right: document.body.scrollWidth - left - width</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>It&#39;s position relative to the viewport (fixed positioning)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      viewport:
        top: top - pageYOffset
        bottom: pageYOffset - top - height + innerHeight
        left: left - pageXOffset
        right: pageXOffset - left - width + innerWidth
    }

    <span class="keyword">if</span> <span class="property">@options</span>.optimizations?.moveElement <span class="keyword">isnt</span> <span class="literal">false</span> <span class="keyword">and</span> <span class="keyword">not</span> <span class="property">@targetModifier</span>?
      offsetParent = <span class="property">@cache</span> <span class="string">'target-offsetparent'</span>, =&gt; getOffsetParent <span class="property">@target</span>
      offsetPosition = <span class="property">@cache</span> <span class="string">'target-offsetparent-bounds'</span>, -&gt; getBounds offsetParent
      offsetParentStyle = getComputedStyle offsetParent
      offsetParentSize = offsetPosition

      offsetBorder = {}
      <span class="keyword">for</span> side <span class="keyword">in</span> [<span class="string">'top'</span>, <span class="string">'left'</span>, <span class="string">'bottom'</span>, <span class="string">'right'</span>]
        offsetBorder[side] = parseFloat offsetParentStyle[<span class="string">"border-<span class="subst">#{ side }</span>-width"</span>]

      offsetPosition.left += offsetBorder.left
      offsetPosition.top += offsetBorder.top

      offsetPosition.right = document.body.scrollWidth - offsetPosition.left - offsetParentSize.width
      offsetPosition.bottom = document.body.scrollHeight - offsetPosition.top - offsetParentSize.height

      <span class="keyword">if</span> next.page.top &gt;= offsetPosition.top <span class="keyword">and</span> next.page.bottom &gt;= offsetPosition.bottom
        <span class="keyword">if</span> next.page.left &gt;= offsetPosition.left <span class="keyword">and</span> next.page.right &gt;= offsetPosition.right</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>We&#39;re within the visible part of the target&#39;s scroll parent</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          scrollTop = offsetParent.scrollTop
          scrollLeft = offsetParent.scrollLeft</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>It&#39;s position relative to the target&#39;s offset parent (absolute positioning when
the element is moved to be a child of the target&#39;s offset parent).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          next.offset =
            top: next.page.top - offsetPosition.top + scrollTop + offsetBorder.top
            left: next.page.left - offsetPosition.left + scrollLeft + offsetBorder.left
            right: next.page.right - offsetPosition.right + offsetParent.scrollWidth - scrollLeft + offsetBorder.right
            bottom: next.page.bottom - offsetPosition.bottom + offsetParent.scrollHeight - scrollTop + offsetBorder.bottom</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>We could also travel up the DOM and try each containing context, rather than only
looking at the body, but we&#39;re gonna get diminishing returns.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="property">@move</span> next

    <span class="property">@history</span>.unshift next

    <span class="keyword">if</span> <span class="property">@history</span>.length &gt; <span class="number">3</span>
      <span class="property">@history</span>.pop()

    <span class="literal">true</span>

  move: (position) -&gt;
    same = {}

    <span class="keyword">for</span> type <span class="keyword">of</span> position
      same[type] = {}

      <span class="keyword">for</span> key <span class="keyword">of</span> position[type]
        found = <span class="literal">false</span>

        <span class="keyword">for</span> point <span class="keyword">in</span> <span class="property">@history</span>
          <span class="keyword">unless</span> point[type]?[key] <span class="keyword">is</span> position[type][key]
            found = <span class="literal">true</span>
            <span class="keyword">break</span>

        <span class="keyword">if</span> <span class="keyword">not</span> found
          same[type][key] = <span class="literal">true</span>
     
    css = {top: <span class="string">''</span>, left: <span class="string">''</span>, right: <span class="string">''</span>, bottom: <span class="string">''</span>}

    <span class="function"><span class="title">transcribe</span></span> = (same, pos) -&gt;
      <span class="keyword">if</span> same.top
        css.top = <span class="string">"<span class="subst">#{ pos.top }</span>px"</span>
      <span class="keyword">else</span>
        css.bottom = <span class="string">"<span class="subst">#{ pos.bottom }</span>px"</span>

      <span class="keyword">if</span> same.left
        css.left = <span class="string">"<span class="subst">#{ pos.left }</span>px"</span>
      <span class="keyword">else</span>
        css.right = <span class="string">"<span class="subst">#{ pos.right }</span>px"</span>

    moved = <span class="literal">false</span>
    <span class="keyword">if</span> (same.page.top <span class="keyword">or</span> same.page.bottom) <span class="keyword">and</span> (same.page.left <span class="keyword">or</span> same.page.right)
      css.position = <span class="string">'absolute'</span>
      transcribe same.page, position.page

    <span class="keyword">else</span> <span class="keyword">if</span> (same.viewport.top <span class="keyword">or</span> same.viewport.bottom) <span class="keyword">and</span> (same.viewport.left <span class="keyword">or</span> same.viewport.right)
      css.position = <span class="string">'fixed'</span>
      transcribe same.viewport, position.viewport

    <span class="keyword">else</span> <span class="keyword">if</span> same.offset? <span class="keyword">and</span> (same.offset.top <span class="keyword">or</span> same.offset.bottom) <span class="keyword">and</span> (same.offset.left <span class="keyword">or</span> same.offset.right)
      css.position = <span class="string">'absolute'</span>

      offsetParent = <span class="property">@cache</span> <span class="string">'target-offsetparent'</span>, =&gt; getOffsetParent <span class="property">@target</span>

      <span class="keyword">if</span> getOffsetParent(<span class="property">@element</span>) <span class="keyword">isnt</span> offsetParent
        <span class="property">@element</span>.parentNode.removeChild <span class="property">@element</span>
        offsetParent.appendChild <span class="property">@element</span>

      offsetParentStyle = getComputedStyle offsetParent

      offset = extend {}, position.offset
      <span class="keyword">for</span> side <span class="keyword">in</span> [<span class="string">'top'</span>, <span class="string">'left'</span>, <span class="string">'bottom'</span>, <span class="string">'right'</span>]
        offset[side] -= parseFloat offsetParentStyle[<span class="string">"border-<span class="subst">#{ side }</span>-width"</span>]

      transcribe same.offset, offset

      moved = <span class="literal">true</span>
      
    <span class="keyword">else</span>
      css.position = <span class="string">'absolute'</span>
      css.top = <span class="string">"<span class="subst">#{ position.page.top }</span>px"</span>
      css.left = <span class="string">"<span class="subst">#{ position.page.left }</span>px"</span>

    <span class="keyword">if</span> <span class="keyword">not</span> moved <span class="keyword">and</span> <span class="property">@element</span>.parentNode.tagName <span class="keyword">isnt</span> <span class="string">'BODY'</span>
      <span class="property">@element</span>.parentNode.removeChild <span class="property">@element</span>
      document.body.appendChild <span class="property">@element</span></pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Any css change will trigger a repaint, so let&#39;s avoid one if nothing changed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    write = <span class="literal">false</span>
    <span class="keyword">for</span> key, val <span class="keyword">of</span> css
      <span class="keyword">if</span> <span class="property">@element</span>.style[key] <span class="keyword">isnt</span> val
        write = <span class="literal">true</span>
        <span class="keyword">break</span>

    <span class="keyword">if</span> write
      extend <span class="property">@element</span>.style, css

window.Tether = extend _Tether, Tether</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
