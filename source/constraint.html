<!DOCTYPE html>

<html>
<head>
  <title>constraint.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="Gruntfile.html">
                Gruntfile.coffee
              </a>
            
              
              <a class="source" href="abutment.html">
                abutment.coffee
              </a>
            
              
              <a class="source" href="constraint.html">
                constraint.coffee
              </a>
            
              
              <a class="source" href="markAttachment.html">
                markAttachment.coffee
              </a>
            
              
              <a class="source" href="shift.html">
                shift.coffee
              </a>
            
              
              <a class="source" href="tether.html">
                tether.coffee
              </a>
            
              
              <a class="source" href="tooltip.html">
                tooltip.coffee
              </a>
            
              
              <a class="source" href="utils.html">
                utils.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>constraint.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>{getOuterSize, getBounds, getSize, extend} = Tether.Utils

MIRROR_ATTACH =
    left: <span class="string">'right'</span>
    right: <span class="string">'left'</span>
    top: <span class="string">'bottom'</span>
    bottom: <span class="string">'top'</span>
    middle: <span class="string">'middle'</span>

BOUNDS_FORMAT = [<span class="string">'left'</span>, <span class="string">'top'</span>, <span class="string">'right'</span>, <span class="string">'bottom'</span>]

<span class="function"><span class="title">getBoundingRect</span></span> = (tether, to) -&gt;
  <span class="keyword">if</span> to <span class="keyword">is</span> <span class="string">'scrollParent'</span>
    to = tether.scrollParent
  <span class="keyword">else</span> <span class="keyword">if</span> to <span class="keyword">is</span> <span class="string">'window'</span>
    to = [pageXOffset, pageYOffset, innerWidth + pageXOffset, innerHeight + pageYOffset]

  <span class="keyword">if</span> to.nodeType?
    pos = size = getBounds to
    style = getComputedStyle to

    to = [pos.left, pos.top, size.width + pos.left, size.height + pos.top]

    <span class="keyword">for</span> side, i <span class="keyword">in</span> BOUNDS_FORMAT
      <span class="keyword">if</span> side <span class="keyword">in</span> [<span class="string">'top'</span>, <span class="string">'left'</span>]
        to[i] += parseFloat style[<span class="string">"border-<span class="subst">#{ side }</span>-width"</span>]
      <span class="keyword">else</span>
        to[i] -= parseFloat style[<span class="string">"border-<span class="subst">#{ side }</span>-width"</span>]

  to

Tether.modules.push
  position: ({top, left, targetAttachment}) -&gt;
    <span class="keyword">return</span> <span class="literal">true</span> <span class="keyword">unless</span> <span class="property">@options</span>.constraints

    <span class="function"><span class="title">removeClass</span></span> = (prefix) =&gt;
      <span class="property">@removeClass</span> prefix
      <span class="keyword">for</span> side <span class="keyword">in</span> BOUNDS_FORMAT
        <span class="property">@removeClass</span> <span class="string">"<span class="subst">#{ prefix }</span>-<span class="subst">#{ side }</span>"</span>

    {height, width} = <span class="property">@cache</span> <span class="string">'element-bounds'</span>, =&gt; getBounds <span class="property">@element</span>

    targetSize = <span class="property">@cache</span> <span class="string">'target-bounds'</span>, =&gt; <span class="property">@getTargetBounds</span>()
    targetHeight = targetSize.height
    targetWidth = targetSize.width

    tAttachment = {}
    eAttachment = {}

    removeClasses = [<span class="property">@getClass</span>(<span class="string">'pinned'</span>), <span class="property">@getClass</span>(<span class="string">'out-of-bounds'</span>)]
    <span class="keyword">for</span> constraint <span class="keyword">in</span> <span class="property">@options</span>.constraints
      removeClasses.push(constraint.outOfBoundsClass) <span class="keyword">if</span> constraint.outOfBoundsClass
      removeClasses.push(constraint.pinnedClass) <span class="keyword">if</span> constraint.pinnedClass

    removeClass(cls) <span class="keyword">for</span> cls <span class="keyword">in</span> removeClasses

    tAttachment = extend {}, targetAttachment
    eAttachment = extend {}, <span class="property">@attachment</span>

    <span class="keyword">for</span> constraint <span class="keyword">in</span> <span class="property">@options</span>.constraints
      {to, attachment, pin} = constraint

      attachment ?= <span class="string">''</span>

      <span class="keyword">if</span> <span class="string">' '</span> <span class="keyword">in</span> attachment
        [changeAttachY, changeAttachX] = attachment.split(<span class="string">' '</span>)
      <span class="keyword">else</span>
        changeAttachX = changeAttachY = attachment

      bounds = getBoundingRect @, to

      <span class="keyword">if</span> changeAttachY <span class="keyword">in</span> [<span class="string">'target'</span>, <span class="string">'both'</span>]
        <span class="keyword">if</span> (top &lt; bounds[<span class="number">1</span>] <span class="keyword">and</span> tAttachment.top <span class="keyword">is</span> <span class="string">'top'</span>)
          top += targetHeight
          tAttachment.top = <span class="string">'bottom'</span>

        <span class="keyword">if</span> (top + height &gt; bounds[<span class="number">3</span>] <span class="keyword">and</span> tAttachment.top <span class="keyword">is</span> <span class="string">'bottom'</span>)
          top -= targetHeight
          tAttachment.top = <span class="string">'top'</span>

      <span class="keyword">if</span> changeAttachY <span class="keyword">is</span> <span class="string">'together'</span>
        <span class="keyword">if</span> top &lt; bounds[<span class="number">1</span>] <span class="keyword">and</span> tAttachment.top <span class="keyword">is</span> <span class="string">'top'</span>
          <span class="keyword">if</span> eAttachment.top <span class="keyword">is</span> <span class="string">'bottom'</span>
            top += targetHeight
            tAttachment.top = <span class="string">'bottom'</span>

            top += height
            eAttachment.top = <span class="string">'top'</span>
          <span class="keyword">else</span> <span class="keyword">if</span> eAttachment.top <span class="keyword">is</span> <span class="string">'top'</span>
            top += targetHeight
            tAttachment.top = <span class="string">'bottom'</span>

            top -= height
            eAttachment.top = <span class="string">'bottom'</span>

        <span class="keyword">if</span> top + height &gt; bounds[<span class="number">3</span>] <span class="keyword">and</span> tAttachment.top <span class="keyword">is</span> <span class="string">'bottom'</span>
          <span class="keyword">if</span> eAttachment.top <span class="keyword">is</span> <span class="string">'top'</span>
            top -= targetHeight
            tAttachment.top = <span class="string">'top'</span>

            top -= height
            eAttachment.top = <span class="string">'bottom'</span>
          <span class="keyword">else</span> <span class="keyword">if</span> eAttachment.top <span class="keyword">is</span> <span class="string">'bottom'</span>
            top -= targetHeight
            tAttachment.top = <span class="string">'top'</span>

            top += height
            eAttachment.top = <span class="string">'top'</span>

      <span class="keyword">if</span> changeAttachX <span class="keyword">in</span> [<span class="string">'target'</span>, <span class="string">'both'</span>]
        <span class="keyword">if</span> (left &lt; bounds[<span class="number">0</span>] <span class="keyword">and</span> tAttachment.left <span class="keyword">is</span> <span class="string">'left'</span>)
          left += targetWidth
          tAttachment.left = <span class="string">'right'</span>

        <span class="keyword">if</span> (left + width &gt; bounds[<span class="number">2</span>] <span class="keyword">and</span> tAttachment.left <span class="keyword">is</span> <span class="string">'right'</span>)
          left -= targetWidth
          tAttachment.left = <span class="string">'left'</span>

      <span class="keyword">if</span> changeAttachX <span class="keyword">is</span> <span class="string">'together'</span>
        <span class="keyword">if</span> left &lt; bounds[<span class="number">0</span>] <span class="keyword">and</span> tAttachment.left <span class="keyword">is</span> <span class="string">'left'</span>
          <span class="keyword">if</span> eAttachment.left <span class="keyword">is</span> <span class="string">'right'</span>
            left += targetWidth
            tAttachment.left = <span class="string">'right'</span>

            left += width
            eAttachment.left = <span class="string">'left'</span>

          <span class="keyword">else</span> <span class="keyword">if</span> eAttachment.left <span class="keyword">is</span> <span class="string">'left'</span>
            left += targetWidth
            tAttachment.left = <span class="string">'right'</span>

            left -= width
            eAttachment.left = <span class="string">'right'</span>

        <span class="keyword">else</span> <span class="keyword">if</span> left + width &gt; bounds[<span class="number">2</span>] <span class="keyword">and</span> tAttachment.left <span class="keyword">is</span> <span class="string">'right'</span>
          <span class="keyword">if</span> eAttachment.left <span class="keyword">is</span> <span class="string">'left'</span>
            left -= targetWidth
            tAttachment.left = <span class="string">'left'</span>

            left -= width
            eAttachment.left = <span class="string">'right'</span>

          <span class="keyword">else</span> <span class="keyword">if</span> eAttachment.left <span class="keyword">is</span> <span class="string">'right'</span>
            left -= targetWidth
            tAttachment.left = <span class="string">'left'</span>

            left += width
            eAttachment.left = <span class="string">'left'</span>

      <span class="keyword">if</span> changeAttachY <span class="keyword">in</span> [<span class="string">'element'</span>, <span class="string">'both'</span>]
        <span class="keyword">if</span> (top &lt; bounds[<span class="number">1</span>] <span class="keyword">and</span> eAttachment.top <span class="keyword">is</span> <span class="string">'bottom'</span>)
          top += height
          eAttachment.top = <span class="string">'top'</span>

        <span class="keyword">if</span> (top + height &gt; bounds[<span class="number">3</span>] <span class="keyword">and</span> eAttachment.top <span class="keyword">is</span> <span class="string">'top'</span>)
          top -= height
          eAttachment.top = <span class="string">'bottom'</span>

      <span class="keyword">if</span> changeAttachX <span class="keyword">in</span> [<span class="string">'element'</span>, <span class="string">'both'</span>]
        <span class="keyword">if</span> (left &lt; bounds[<span class="number">0</span>] <span class="keyword">and</span> eAttachment.left <span class="keyword">is</span> <span class="string">'right'</span>)
          left += width
          eAttachment.left = <span class="string">'left'</span>

        <span class="keyword">if</span> (left + width &gt; bounds[<span class="number">2</span>] <span class="keyword">and</span> eAttachment.left <span class="keyword">is</span> <span class="string">'left'</span>)
          left -= width
          eAttachment.left = <span class="string">'right'</span>

      <span class="keyword">if</span> <span class="keyword">typeof</span> pin <span class="keyword">is</span> <span class="string">'string'</span>
        pin = (p.trim() <span class="keyword">for</span> p <span class="keyword">in</span> pin.split <span class="string">','</span>)
      <span class="keyword">else</span> <span class="keyword">if</span> pin <span class="keyword">is</span> <span class="literal">true</span>
        pin = [<span class="string">'top'</span>, <span class="string">'left'</span>, <span class="string">'right'</span>, <span class="string">'bottom'</span>]
      
      pin <span class="keyword">or</span>= []

      pinned = []
      oob = []
      <span class="keyword">if</span> top &lt; bounds[<span class="number">1</span>]
        <span class="keyword">if</span> <span class="string">'top'</span> <span class="keyword">in</span> pin
          top = bounds[<span class="number">1</span>]
          pinned.push <span class="string">'top'</span>
        <span class="keyword">else</span>
          oob.push <span class="string">'top'</span>

      <span class="keyword">if</span> top + height &gt; bounds[<span class="number">3</span>]
        <span class="keyword">if</span> <span class="string">'bottom'</span> <span class="keyword">in</span> pin
          top = bounds[<span class="number">3</span>] - height
          pinned.push <span class="string">'bottom'</span>
        <span class="keyword">else</span>
          oob.push <span class="string">'bottom'</span>

      <span class="keyword">if</span> left &lt; bounds[<span class="number">0</span>]
        <span class="keyword">if</span> <span class="string">'left'</span> <span class="keyword">in</span> pin
          left = bounds[<span class="number">0</span>]
          pinned.push <span class="string">'left'</span>
        <span class="keyword">else</span>
          oob.push <span class="string">'left'</span>

      <span class="keyword">if</span> left + width &gt; bounds[<span class="number">2</span>]
        <span class="keyword">if</span> <span class="string">'right'</span> <span class="keyword">in</span> pin
          left = bounds[<span class="number">2</span>] - width
          pinned.push <span class="string">'right'</span>
        <span class="keyword">else</span>
          oob.push <span class="string">'right'</span>

      <span class="keyword">if</span> pinned.length
        pinnedClass = <span class="property">@options</span>.pinnedClass ? <span class="property">@getClass</span>(<span class="string">'pinned'</span>)
        <span class="property">@addClass</span> pinnedClass
        <span class="keyword">for</span> side <span class="keyword">in</span> pinned
          <span class="property">@addClass</span> <span class="string">"<span class="subst">#{ pinnedClass }</span>-<span class="subst">#{ side }</span>"</span>

      <span class="keyword">if</span> oob.length
        oobClass = <span class="property">@options</span>.outOfBoundsClass ? <span class="property">@getClass</span>(<span class="string">'out-of-bounds'</span>)
        <span class="property">@addClass</span> oobClass
        <span class="keyword">for</span> side <span class="keyword">in</span> oob
          <span class="property">@addClass</span> <span class="string">"<span class="subst">#{ oobClass }</span>-<span class="subst">#{ side }</span>"</span>

      <span class="keyword">if</span> <span class="string">'left'</span> <span class="keyword">in</span> pinned <span class="keyword">or</span> <span class="string">'right'</span> <span class="keyword">in</span> pinned
        eAttachment.left = tAttachment.left = <span class="literal">false</span>
      <span class="keyword">if</span> <span class="string">'top'</span> <span class="keyword">in</span> pinned <span class="keyword">or</span> <span class="string">'bottom'</span> <span class="keyword">in</span> pinned
        eAttachment.top = tAttachment.top = <span class="literal">false</span>

      <span class="keyword">if</span> tAttachment.top <span class="keyword">isnt</span> targetAttachment.top <span class="keyword">or</span> tAttachment.left <span class="keyword">isnt</span> targetAttachment.left <span class="keyword">or</span> eAttachment.top <span class="keyword">isnt</span> <span class="property">@attachment</span>.top <span class="keyword">or</span> eAttachment.left <span class="keyword">isnt</span> <span class="property">@attachment</span>.left
        <span class="property">@updateAttachClasses</span> eAttachment, tAttachment

    {top, left}</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
